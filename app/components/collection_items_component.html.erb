<div class="row align-items-start" id="collection-items-list">
  <% if @collection_items.present? %>
    <% @collection_items.each do |collection_item| %>
      <% if collection_item['is_issue']&.first == "Yes" %>
        <div class="card" style="width: 20rem; width: 20rem; margin: 0 1.4rem 1rem 0;">
        <div class="card-img-top" id="osd-<%= collection_item['id'] %>" style="height: 250px; border-bottom: 1px solid #ccc; margin-bottom: 1rem;"></div>
          <div class="card-body">
            <% if collection_item['subtitle_tsim'] %>
              <h5 class="card-title">
                <a class="" href="/catalog/<%= collection_item['id'] %>">
                  <%= collection_item['subtitle_tsim'][0] %>
                </a>
              </h5>
            <% end %>

            <% if collection_item['pub_date_si'] %>
              <p class="card-text"><%= collection_item['pub_date_si'][0] %></p>
            <% end %>
            <% if collection_item['collection_tsim'] %>
                <p class="card-text"><%= collection_item['collection_tsim'].last %></p>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  <% else %>
    <p><%= t('labels.L_NO_ISSUES_MSG') %></p>
  <% end %>
</div>

<% max_visible = 5 %>
<% start_page = [@page - 2, 1].max %>
<% end_page = [start_page + max_visible - 1, @total_pages].min %>
<% start_page = [end_page - max_visible + 1, 1].max %>

<div class="row align-items-start">
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      <% if @page > 1 %>
        <li class="page-item">
          <%= link_to 'First', url_for(params.to_unsafe_h.merge(page: 1)), class: 'page-link' %>
        </li>
        <li class="page-item">
          <%= link_to 'Previous', url_for(params.to_unsafe_h.merge(page: @page - 1)), class: 'page-link' %>
        </li>
      <% else %>
        <li class="page-item disabled"><span class="page-link">First</span></li>
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      <% end %>

      <% if start_page > 1 %>
        <li class="page-item disabled"><span class="page-link">…</span></li>
      <% end %>

      <% (start_page..end_page).each do |p| %>
        <li class="page-item <%= 'active' if p == @page %>">
          <%= link_to p, url_for(params.to_unsafe_h.merge(page: p)), class: 'page-link' %>
        </li>
      <% end %>

      <% if end_page < @total_pages %>
        <li class="page-item disabled"><span class="page-link">…</span></li>
      <% end %>

      <% if @page < @total_pages %>
        <li class="page-item">
          <%= link_to 'Next', url_for(params.to_unsafe_h.merge(page: @page + 1)), class: 'page-link' %>
        </li>
        <li class="page-item">
          <%= link_to 'Last', url_for(params.to_unsafe_h.merge(page: @total_pages)), class: 'page-link' %>
        </li>
      <% else %>
        <li class="page-item disabled"><span class="page-link">Next</span></li>
        <li class="page-item disabled"><span class="page-link">Last</span></li>
      <% end %>
    </ul>
  </nav>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  <% @collection_items.each do |item| %>
  (async function () {
    const arkId = "<%= item['ark'].sub('https://n2t.net/ark:/', '') %>";
    const manifestUrl = `https://crkn-iiif-api.azurewebsites.net/manifest/${arkId}`;
    const containerId = "osd-<%= item['id'] %>";
    const container = document.getElementById(containerId);
    if (!container) return;

    try {
      const response = await fetch(manifestUrl);
      const manifest = await response.json();
      const canvases = manifest.items || [];
      const tileSources = canvases.map(canvas => {
        const parts = canvas.id.split('/');
        const lastTwoParts = parts.slice(-2).join('/');
        return `https://image-tor.canadiana.ca/iiif/2/${encodeURIComponent(lastTwoParts)}/info.json`;
      });

      OpenSeadragon({
        element: container,
        prefixUrl: "/assets/",
        sequenceMode: true,
        tileSources: tileSources,
        immediateRender: true,
        showReferenceStrip: false
      });

    } catch (e) {
      console.error("Failed to load manifest or initialize OpenSeadragon for", containerId, e);
    }
  })();
  <% end %>
});
</script>

