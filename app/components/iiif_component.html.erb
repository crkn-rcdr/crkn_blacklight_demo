<% manifest_url = @document['ark']&.gsub('https://n2t.net/ark:', 'https://crkn-iiif-api.azurewebsites.net/manifest') %>

<div class="toolbox-card card" aria-labelledby="iiif-toolbox-title">
  <% has_manifest = manifest_url.present? %>
  <div class="toolbox-header d-flex align-items-center justify-content-between mb-2">
    <h3 id="iiif-toolbox-title" class="h5 mb-0"><%= t('blacklight.iiif_toolbox.title') %></h3>
    <%# Optional subtle helper text %>
    <small class="text-muted d-none d-md-inline"><%= t('blacklight.iiif_toolbox.subtitle') %></small>
  </div>

  <div class="toolbox-actions d-flex flex-wrap align-items-center gap-2 mb-2">
    <img src="/assets/iiif_logo.png" height="28" class="me-2" alt="IIIF" />

    <button class="copy-link-btn" <%= 'disabled' unless has_manifest %>
            type="button"
            onclick="copyManifestUrl(this)"
            title="<%= t('blacklight.iiif_toolbox.copy_tooltip') %>">
      <i class="bi bi-link-45deg" aria-hidden="true"></i>
      <span><%= t('blacklight.iiif_toolbox.copy_manifest_link') %></span>
    </button>

    <a class="btn btn-outline-secondary <%= 'disabled' unless has_manifest %>" target="_blank"
       rel="noopener noreferrer"
       title="<%= t('blacklight.iiif_toolbox.crop_tooltip') %>"
       href="<%= has_manifest ? "https://mcgrawcenter.github.io/croppingtool/?manifest=#{manifest_url}" : '#' %>"
      <i class="bi bi-crop me-1" aria-hidden="true"></i>
      <%= t('blacklight.iiif_toolbox.crop_image') %>
    </a>

    <a class="btn btn-outline-secondary <%= 'disabled' unless has_manifest %>" target="_blank"
       rel="noopener noreferrer"
       title="<%= t('blacklight.iiif_toolbox.pdf_tooltip') %>"
       href="<%= has_manifest ? "https://pdiiif.jbaiter.de/?manifest=#{manifest_url}" : '#' %>"
      <i class="bi bi-filetype-pdf me-1" aria-hidden="true"></i>
      <%= t('blacklight.iiif_toolbox.generate_pdf') %>
    </a>

    <a class="btn btn-outline-secondary <%= 'disabled' unless has_manifest %>" target="_blank"
       rel="noopener noreferrer"
       title="<%= t('blacklight.iiif_toolbox.edit_manifest_tooltip') %>"
       href="<%= has_manifest ? "https://manifest-editor.digirati.services/share?iiif-content=#{manifest_url}" : '#' %>"
      <i class="bi bi-pencil-square me-1" aria-hidden="true"></i>
      <%= t('blacklight.iiif_toolbox.edit_manifest_copy') %>
    </a>
  </div>

  <div class="toolbox-links">
    <% lang_qs = params[:lang].present? ? "?lang=#{params[:lang]}" : '' %>
    <ul class="list-unstyled mb-0">
      <li class="mb-1">
        <a href="https://iiif.io/get-started/" target="_blank" rel="noopener">
          <i class="bi bi-question-circle me-1" aria-hidden="true"></i>
          <%= t('blacklight.iiif_toolbox.what_is_iiif') %>
        </a>
      </li>
      <li class="mb-1">
        <a href="/catalog/<%= @document.id %>/librarian_view<%= lang_qs %>" data-blacklight-modal="trigger" data-turbo="false">
          <i class="bi bi-journal-text me-1" aria-hidden="true"></i>
          <%= t('blacklight.iiif_toolbox.librarian_view') %>
        </a>
      </li>
      <li>
        <a href="/catalog/<%= @document.id %>/citation<%= lang_qs %>" data-blacklight-modal="trigger" data-turbo="false">
          <i class="bi bi-quote me-1" aria-hidden="true"></i>
          <%= t('blacklight.iiif_toolbox.cite') %>
        </a>
      </li>
    </ul>
  </div>

  <a id="iiif-manifest-url" href="<%= manifest_url %>" class="visually-hidden"><%= manifest_url %></a>
  <span id="iiif-copy-feedback" class="visually-hidden" aria-live="polite"></span>
</div>

<script>
  function copyManifestUrl(button) {
    const text = document.getElementById("iiif-manifest-url").textContent.trim();
    const label = button.querySelector("span");
    const live = document.getElementById("iiif-copy-feedback");

    if (!label) return;

    const originalText = label.textContent;
    const copiedText = <%= raw t('blacklight.iiif_toolbox.copied_js').to_json %>;
    const copyFailedText = <%= raw t('blacklight.iiif_toolbox.copy_failed_js').to_json %>;

    function setCopiedFeedback() {
      label.textContent = copiedText;
      if (live) live.textContent = copiedText;
      setTimeout(() => {
        label.textContent = originalText;
        if (live) live.textContent = "";
      }, 2000);
    }

    function setFailedFeedback() {
      if (live) live.textContent = copyFailedText;
      alert(copyFailedText);
    }

    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(text)
        .then(setCopiedFeedback)
        .catch(err => {
          console.error("Copy failed", err);
          setFailedFeedback();
        });
    } else {
      const tempInput = document.createElement("textarea");
      tempInput.value = text;
      tempInput.style.position = "absolute";
      tempInput.style.left = "-9999px";
      document.body.appendChild(tempInput);
      tempInput.select();
      try {
        const success = document.execCommand("copy");
        if (success) {
          setCopiedFeedback();
        } else {
          setFailedFeedback();
        }
      } catch (err) {
        console.error("Fallback copy failed", err);
        setFailedFeedback();
      }
      document.body.removeChild(tempInput);
    }
  }
</script>
