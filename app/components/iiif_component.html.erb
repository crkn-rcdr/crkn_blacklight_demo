<% manifest_url = @document['ark']&.gsub('https://n2t.net/ark:', Rails.configuration.x.iiif_manifest_base) %>

<div class="toolbox-card card" aria-labelledby="iiif-toolbox-title">
  <% has_manifest = manifest_url.present? %>
  <div class="toolbox-header d-flex align-items-center justify-content-between mb-2">
    <h3 id="iiif-toolbox-title" class="h5 mb-0"><%= t('blacklight.tools.title') %></h3>
  </div>

  <div class="toolbox-actions d-flex flex-wrap align-items-center gap-2 mb-2">
    <img src="/assets/iiif_logo.png" height="28" class="me-2" alt="IIIF" />

    <%= button_tag type: 'button',
                   class: ["btn", "btn-soft-primary", "btn-sm", "copy-link-btn", (has_manifest ? nil : "disabled")].compact.join(' '),
                   onclick: 'copyManifestUrl(this)',
                   title: t('blacklight.tools.copy_tooltip'),
                   disabled: (has_manifest ? nil : true),
                   aria: (has_manifest ? {} : { disabled: true }) do %>
      <i class="bi bi-link-45deg" aria-hidden="true"></i>
      <span><%= t('blacklight.tools.copy_manifest_link') %></span>
    <% end %>

    <% crop_href = has_manifest ? "https://mcgrawcenter.github.io/croppingtool/?manifest=#{manifest_url}" : '#' %>
    <% crop_classes = ["btn", "btn-soft-secondary", "btn-sm", (has_manifest ? nil : "disabled")] %>
    <%= link_to crop_href,
                { class: crop_classes.compact.join(' '),
                  title: t('blacklight.tools.crop_tooltip'),
                  target: "_blank",
                  rel: "noopener noreferrer",
                  tabindex: (has_manifest ? nil : -1),
                  aria: (has_manifest ? {} : { disabled: true }) } do %>
      <i class="bi bi-crop me-1" aria-hidden="true"></i>
      <%= t('blacklight.tools.crop_image') %>
    <% end %>

    <% pdf_href = has_manifest ? "https://pdiiif.jbaiter.de/?manifest=#{manifest_url}" : '#' %>
    <% pdf_classes = ["btn", "btn-soft-secondary", "btn-sm", (has_manifest ? nil : "disabled")] %>
    <%= link_to pdf_href,
                { class: pdf_classes.compact.join(' '),
                  title: t('blacklight.tools.pdf_tooltip'),
                  target: "_blank",
                  rel: "noopener noreferrer",
                  tabindex: (has_manifest ? nil : -1),
                  aria: (has_manifest ? {} : { disabled: true }) } do %>
      <i class="bi bi-filetype-pdf me-1" aria-hidden="true"></i>
      <%= t('blacklight.tools.generate_pdf') %>
    <% end %>

    <% edit_href = has_manifest ? "https://manifest-editor.digirati.services/share?iiif-content=#{manifest_url}" : '#' %>
    <% edit_classes = ["btn", "btn-soft-secondary", "btn-sm", (has_manifest ? nil : "disabled")] %>
    <%= link_to edit_href,
                { class: edit_classes.compact.join(' '),
                  title: t('blacklight.tools.edit_manifest_tooltip'),
                  target: "_blank",
                  rel: "noopener noreferrer",
                  tabindex: (has_manifest ? nil : -1),
                  aria: (has_manifest ? {} : { disabled: true }) } do %>
      <i class="bi bi-pencil-square me-1" aria-hidden="true"></i>
      <%= t('blacklight.tools.edit_manifest_copy') %>
    <% end %>
  </div>

  <div class="toolbox-links">
    <ul class="list-unstyled mb-0">
      <li class="mb-1">
        <a href="https://iiif.io/get-started/" target="_blank" rel="noopener">
          <i class="bi bi-question-circle me-1" aria-hidden="true"></i>
          <%= t('blacklight.tools.what_is_iiif') %>
        </a>
      </li>
    </ul>
  </div>

  <a id="iiif-manifest-url" href="<%= manifest_url %>" class="visually-hidden"><%= manifest_url %></a>
  <span id="iiif-copy-feedback" class="visually-hidden" aria-live="polite"></span>
</div>

<script>
  function copyManifestUrl(button) {
    const text = document.getElementById("iiif-manifest-url").textContent.trim();
    const label = button.querySelector("span");
    const live = document.getElementById("iiif-copy-feedback");

    if (!label) return;

    const originalText = label.textContent;
    const copiedText = <%= raw t('blacklight.tools.copied_js').to_json %>;
    const copyFailedText = <%= raw t('blacklight.tools.copy_failed_js').to_json %>;

    function setCopiedFeedback() {
      label.textContent = copiedText;
      if (live) live.textContent = copiedText;
      setTimeout(() => {
        label.textContent = originalText;
        if (live) live.textContent = "";
      }, 2000);
    }

    function setFailedFeedback() {
      if (live) live.textContent = copyFailedText;
      alert(copyFailedText);
    }

    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(text)
        .then(setCopiedFeedback)
        .catch(err => {
          console.error("Copy failed", err);
          setFailedFeedback();
        });
    } else {
      const tempInput = document.createElement("textarea");
      tempInput.value = text;
      tempInput.style.position = "absolute";
      tempInput.style.left = "-9999px";
      document.body.appendChild(tempInput);
      tempInput.select();
      try {
        const success = document.execCommand("copy");
        if (success) {
          setCopiedFeedback();
        } else {
          setFailedFeedback();
        }
      } catch (err) {
        console.error("Fallback copy failed", err);
        setFailedFeedback();
      }
      document.body.removeChild(tempInput);
    }
  }
</script>
